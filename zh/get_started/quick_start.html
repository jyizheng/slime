
<!DOCTYPE html>


<html lang="zh" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>å¿«é€Ÿä½¿ç”¨ &#8212; slime</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom_log.css?v=ad20845f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=30c3115b"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'get_started/quick_start';</script>
    <script src="../_static/js/lang-toggle.js?v=8d03b7be"></script>
    <script src="../_static/js/runllm-widget.js?v=07dc06db"></script>
    <link rel="icon" href="../_static/logo.ico"/>
    <link rel="index" title="ç´¢å¼•" href="../genindex.html" />
    <link rel="search" title="æœç´¢" href="../search.html" />
    <link rel="next" title="ä½¿ç”¨æ–‡æ¡£" href="usage.html" />
    <link rel="prev" title="slimeæ–‡æ¡£" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="zh"/>
    <meta name="docbuild:last-update" content="2025 å¹´ 09 æœˆ 06 æ—¥"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.jpg" class="logo__image only-light" alt="slime - Home"/>
    <script>document.write(`<img src="../_static/logo.jpg" class="logo__image only-dark" alt="slime - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="æœç´¢" aria-label="æœç´¢" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">æœç´¢</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">å¼€å§‹ä½¿ç”¨</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">å¿«é€Ÿä½¿ç”¨</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">ä½¿ç”¨æ–‡æ¡£</a></li>
<li class="toctree-l1"><a class="reference internal" href="qa.html">å¸¸è§ Q&amp;A</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dense</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../examples/qwen3-4B.html">8xH100 è®­ç»ƒ Qwen3-4B</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/glm4-9B.html">8xH100 è®­ç»ƒ GLM4-9B</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MoE</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../examples/qwen3-30B-A3B.html">8xH100 è®­ç»ƒ Qwen3-30B-A3B</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/glm4.5-355B-A32B.html">64xH100 è®­ç»ƒ GLM-4.5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/deepseek-r1.html">128xH100 è®­ç»ƒ DeepSeek R1</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">å…¶ä»–ç”¨æ³•</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../examples/qwen3-4b-base-openhermes.html">SFT Qwen3-4B-Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_examples_synced/search-r1/README.html">Search-R1 lite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_examples_synced/fully_async/README.html">Fully Asynchronous Rollout Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_examples_synced/retool/README.html">Retool: from SFT to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_examples_synced/multi_agent/README.html">Multi-Agent RL</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">é«˜çº§ç‰¹æ€§</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../advanced/speculative-decoding.html">Speculative decoding ä½¿ç”¨æŒ‡å—</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">å¼€å‘æŒ‡å—</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/debug.html">Debug æŒ‡å—</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">åšå®¢</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../blogs/introducing_slime.html">slimeï¼šä¸º RL Scaling è®¾è®¡çš„ SGLang-Native åè®­ç»ƒæ¡†æ¶</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blogs/release_v0.1.0.html">v0.1.0: é‡æ–°å®šä¹‰é«˜æ€§èƒ½ RL è®­ç»ƒæ¡†æ¶</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/THUDM/slime" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="æºç åº“"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/THUDM/slime/blob/main/get_started/quick_start.md?plain=1" target="_blank"
   class="btn btn-sm btn-source-file-button dropdown-item"
   title="Show source"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">Show source</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/THUDM/slime/edit/main/get_started/quick_start.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/THUDM/slime/issues/new?title=Issue%20on%20page%20%2Fget_started/quick_start.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="åˆ›å»ºè®®é¢˜"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="ä¸‹è½½æ­¤é¡µé¢">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/get_started/quick_start.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="ä¸‹è½½æºæ–‡ä»¶"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="åˆ—å°æˆ PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="å…¨å±æ¨¡å¼"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="æœç´¢" aria-label="æœç´¢" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>å¿«é€Ÿä½¿ç”¨</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> ç›®å½• </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">åŸºç¡€ç¯å¢ƒæ­å»º</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#docker">æ‹‰å–å¹¶å¯åŠ¨ Docker å®¹å™¨</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#slime">å®‰è£… slime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">æ¨¡å‹ä¸æ•°æ®é›†ä¸‹è½½</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">æ¨¡å‹æƒé‡è½¬æ¢</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hugging-face-megatron">Hugging Face æ ¼å¼ è½¬æ¢ä¸º Megatron æ ¼å¼</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#megatron-hugging-face">Megatron æ ¼å¼ è½¬æ¢ä¸º Hugging Face æ ¼å¼</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">è®­ç»ƒè„šæœ¬ä¸å‚æ•°æ¦‚è§ˆ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-args">MODEL_ARGS: æ¨¡å‹é…ç½®å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ckpt-args">CKPT_ARGS: æ£€æŸ¥ç‚¹ä¸è·¯å¾„å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rollout-args-rollout">ROLLOUT_ARGS: æ•°æ®ç”Ÿæˆï¼ˆRolloutï¼‰å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eval-args">EVAL_ARGS: è¯„ä¼°å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perf-args">PERF_ARGS: æ€§èƒ½ä¸å¹¶è¡Œå‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grpo-args-grpo">GRPO_ARGS: GRPO ç®—æ³•å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizer-args">OPTIMIZER_ARGS: ä¼˜åŒ–å™¨å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sglang-args-sglang">SGLANG_ARGS: SGLang æœåŠ¡å‚æ•°</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">ç‰¹æ€§ä»‹ç»</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#colocated-actor-and-rollout">Colocated Actor and Rollout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-sampling">Dynamic Sampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-rollout">Partial Rollout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bf16-fp8">bf16 è®­ç»ƒ fp8 æ¨ç†</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiturn">Multiturn é€‚é…</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">é€‚é…æ€è·¯æ€»ç»“</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">æ•°æ®å‡†å¤‡ä¸æ˜ å°„</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">æ­¥éª¤ä¸€ï¼šåœ¨æ•°æ®é›†ä¸­æ„é€  <code class="docutils literal notranslate"><span class="pre">metadata</span></code> å­—æ®µ</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">æ­¥éª¤äºŒï¼šåœ¨è®­ç»ƒè„šæœ¬ä¸­æŒ‡å®šæ˜ å°„</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">ç¼–å†™è‡ªå®šä¹‰ç”Ÿæˆå‡½æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">ç¼–å†™è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">åœ¨è®­ç»ƒè„šæœ¬ä¸­é…ç½®</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moe">å¤§è§„æ¨¡ MOE æ¨¡å‹çš„å¤šæœºè®­ç»ƒ</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>å¿«é€Ÿä½¿ç”¨<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>æœ¬æ–‡æ¡£ä»æ­å»ºç¯å¢ƒå¼€å§‹ï¼Œåœ¨ä¸€å°æ—¶å†…å¸¦æ‚¨å¿«é€Ÿä¸Šæ‰‹ slimeï¼Œæ¶µç›–ç¯å¢ƒé…ç½®ï¼Œæ•°æ®å‡†å¤‡ï¼Œè®­ç»ƒå¯åŠ¨å’Œå…³é”®ä»£ç è§£æå’Œé­”æ”¹ã€‚</p>
<section id="id2">
<h2>åŸºç¡€ç¯å¢ƒæ­å»º<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>ç”±äº slime å¯èƒ½ä¼šåŒ…å«é’ˆå¯¹ sglang/megatron çš„ä¸´æ—¶è¡¥ä¸ï¼ˆpatchï¼‰ã€‚ä¸ºé¿å…æ½œåœ¨çš„ç¯å¢ƒé…ç½®é—®é¢˜ï¼Œå¼ºçƒˆå»ºè®®<strong>ç”¨æˆ·ä½¿ç”¨æˆ‘ä»¬æä¾›çš„æœ€æ–° Docker é•œåƒ</strong>ï¼Œå®ƒå·²é¢„ç½®å¥½æ‰€æœ‰ä¾èµ–ã€‚</p>
<ul class="simple">
<li><p>å¯¹äºä¸æ–¹ä¾¿ä½¿ç”¨ docker çš„åœºæ™¯ï¼Œè¯·å‚è€ƒ <a class="reference internal" href="#./../../build_conda.sh"><span class="xref myst">build_conda.sh</span></a>ï¼›</p></li>
<li><p>å¯¹äº AMD æ”¯æŒï¼Œè¯·å‚è€ƒ <a class="reference internal" href="#../en/amd_tutorial.md"><span class="xref myst">AMD ä½¿ç”¨æ•™ç¨‹</span></a>ã€‚</p></li>
</ul>
<section id="docker">
<h3>æ‹‰å–å¹¶å¯åŠ¨ Docker å®¹å™¨<a class="headerlink" href="#docker" title="Link to this heading">#</a></h3>
<p>è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ‹‰å–æœ€æ–°é•œåƒå¹¶å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼å®¹å™¨ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ‹‰å–æœ€æ–°é•œåƒ</span>
docker<span class="w"> </span>pull<span class="w"> </span>zhuzilin/slime:latest

<span class="c1"># å¯åŠ¨å®¹å™¨</span>
docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--gpus<span class="w"> </span>all<span class="w"> </span>--ipc<span class="o">=</span>host<span class="w"> </span>--shm-size<span class="o">=</span>16g<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--ulimit<span class="w"> </span><span class="nv">memlock</span><span class="o">=</span>-1<span class="w"> </span>--ulimit<span class="w"> </span><span class="nv">stack</span><span class="o">=</span><span class="m">67108864</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-it<span class="w"> </span>zhuzilin/slime:latest<span class="w"> </span>/bin/bash
</pre></div>
</div>
</section>
<section id="slime">
<h3>å®‰è£… slime<a class="headerlink" href="#slime" title="Link to this heading">#</a></h3>
<p>è¿›å…¥ Docker å®¹å™¨åï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å…‹éš† slime ä»“åº“å¹¶è¿›è¡Œå®‰è£…ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># è·¯å¾„å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´</span>
<span class="nb">cd</span><span class="w"> </span>/root/
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/THUDM/slime.git
<span class="nb">cd</span><span class="w"> </span>slime
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</pre></div>
</div>
</section>
</section>
<section id="id3">
<h2>æ¨¡å‹ä¸æ•°æ®é›†ä¸‹è½½<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>å¯ä»¥ä» Hugging Faceã€ModelScope ç­‰å¹³å°ä¸‹è½½æ‰€éœ€çš„æ¨¡å‹å’Œæ•°æ®é›†ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">huggingface_hub</span></code> ä¸‹è½½ç¤ºä¾‹èµ„æºçš„å‘½ä»¤ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>huggingface_hub

<span class="c1"># ä¸‹è½½æ¨¡å‹æƒé‡ (GLM-Z1-9B)</span>
hf<span class="w"> </span>download<span class="w"> </span>zai-org/GLM-Z1-9B-0414<span class="w"> </span>--local-dir<span class="w"> </span>/root/GLM-Z1-9B-0414

<span class="c1"># ä¸‹è½½è®­ç»ƒæ•°æ®é›† (dapo-math-17k)</span>
hf<span class="w"> </span>download<span class="w"> </span>--repo-type<span class="w"> </span>dataset<span class="w"> </span>zhuzilin/dapo-math-17k<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--local-dir<span class="w"> </span>/root/dapo-math-17k

<span class="c1"># ä¸‹è½½è¯„ä¼°æ•°æ®é›† (aime-2024)</span>
hf<span class="w"> </span>download<span class="w"> </span>--repo-type<span class="w"> </span>dataset<span class="w"> </span>zhuzilin/aime-2024<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--local-dir<span class="w"> </span>/root/aime-2024
</pre></div>
</div>
</section>
<section id="id4">
<h2>æ¨¡å‹æƒé‡è½¬æ¢<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<section id="hugging-face-megatron">
<h3>Hugging Face æ ¼å¼ è½¬æ¢ä¸º Megatron æ ¼å¼<a class="headerlink" href="#hugging-face-megatron" title="Link to this heading">#</a></h3>
<p>å½“ä½¿ç”¨ Megatron ä½œä¸ºè®­ç»ƒåç«¯æ—¶ï¼Œéœ€è¦å…ˆå°† Hugging Face æ ¼å¼çš„æ¨¡å‹æƒé‡è½¬æ¢ä¸º Megatron <code class="docutils literal notranslate"><span class="pre">torch_dist</span></code> æ ¼å¼ã€‚</p>
<p>é¦–å…ˆï¼ŒåŠ è½½ç›®æ ‡æ¨¡å‹çš„é…ç½®æ–‡ä»¶ã€‚<code class="docutils literal notranslate"><span class="pre">slime/scripts/models</span></code> ç›®å½•ä¸‹åŒ…å«äº†æ”¯æŒæ¨¡å‹çš„é…ç½®æ–‡ä»¶ã€‚éœ€è¦ <code class="docutils literal notranslate"><span class="pre">source</span></code> å¯¹åº”æ¨¡å‹çš„è„šæœ¬ï¼Œå°†é…ç½®å‚æ•°åŠ è½½åˆ°å½“å‰ç¯å¢ƒä¸­ã€‚æ­¤å¤„æˆ‘ä»¬ä»¥ GLM4-9B æ¨¡å‹ä¸ºä¾‹å­ï¼Œå¯¹äº Qwen3-4Bï¼ŒQwen3-30B-A3Bï¼Œæ˜¯ç±»ä¼¼çš„ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/root/slime
<span class="nb">source</span><span class="w"> </span>scripts/models/glm4-9B.sh
</pre></div>
</div>
<p>æ¥ä¸‹æ¥ï¼Œè¿è¡Œè½¬æ¢è„šæœ¬ã€‚è¯·æ³¨æ„ä»¥ä¸‹å‚æ•°ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--hf-checkpoint</span></code>: æŒ‡å®šå·²ä¸‹è½½çš„ Hugging Face æ¨¡å‹æƒé‡è·¯å¾„ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--save</span></code>: æŒ‡å®šè½¬æ¢å <code class="docutils literal notranslate"><span class="pre">torch_dist</span></code> æ ¼å¼æƒé‡çš„ä¿å­˜è·¯å¾„ã€‚</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONPATH</span><span class="o">=</span>/root/Megatron-LM<span class="w"> </span>python<span class="w"> </span>tools/convert_hf_to_torch_dist.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="si">${</span><span class="nv">MODEL_ARGS</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--hf-checkpoint<span class="w"> </span>/root/GLM-Z1-9B-0414<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save<span class="w"> </span>/root/GLM-Z1-9B-0414_torch_dist
</pre></div>
</div>
<p>å¯¹äºæ›´å¤§çš„æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">torchrun</span></code> æ¥å¯åŠ¨è½¬æ¢è„šæœ¬ï¼Œä»è€Œä½¿ç”¨å¤šå¼  GPU ç”šè‡³å¤šæœºè¿›è¡Œæƒé‡è½¬æ¢ã€‚</p>
</section>
<section id="megatron-hugging-face">
<h3>Megatron æ ¼å¼ è½¬æ¢ä¸º Hugging Face æ ¼å¼<a class="headerlink" href="#megatron-hugging-face" title="Link to this heading">#</a></h3>
<p>å¯ä»¥é€šè¿‡è¿™æ ·çš„æ–¹å¼å°†è®­ç»ƒè¿‡ç¨‹ä¸­ä¿å­˜çš„ Megatron æ ¼å¼çš„æƒé‡è½¬æ¢å› Huggingface æ ¼å¼ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONPATH</span><span class="o">=</span>/root/Megatron-LM<span class="w"> </span>python<span class="w"> </span>tools/convert_torch_dist_to_hf.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--input-dir<span class="w"> </span>/path/to/torch_dist_ckpt/iter_xxx/<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output-dir<span class="w"> </span>/root/GLM-Z1-9B-0414-iter_xxx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--origin-hf-dir<span class="w"> </span>/root/GLM-Z1-9B-0414
</pre></div>
</div>
<p>ç”±äº Megatron ä¼šå¯¹ embedding åš paddingï¼Œå¯èƒ½ä¼šå‡ºç°è½¬æ¢å‡ºæ¥çš„æƒé‡çš„ embedding å½¢çŠ¶ä¸åŒ¹é…çš„é—®é¢˜ã€‚è¿™æ—¶éœ€è¦åœ¨è½¬æ¢æ—¶è®¾ç½® <code class="docutils literal notranslate"><span class="pre">--vocab-size</span></code>ã€‚</p>
</section>
</section>
<section id="id5">
<h2>è®­ç»ƒè„šæœ¬ä¸å‚æ•°æ¦‚è§ˆ<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>å®Œæˆä¸Šè¿°å‡†å¤‡å·¥ä½œåï¼Œå³å¯è¿è¡Œè®­ç»ƒè„šæœ¬ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/root/slime
bash<span class="w"> </span>scripts/run-glm4-9B.sh
</pre></div>
</div>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ run-glm4-9B.sh è„šæœ¬ä¸ºä¾‹ï¼Œç®€å•åˆ†æä¸»è¦å‚æ•°çš„ä½œç”¨ã€‚</p>
<section id="model-args">
<h3>MODEL_ARGS: æ¨¡å‹é…ç½®å‚æ•°<a class="headerlink" href="#model-args" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">cd</span><span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">pwd</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/models/glm4-9B.sh&quot;</span>
</pre></div>
</div>
<p>æ­¤éƒ¨åˆ†é€šè¿‡ <code class="docutils literal notranslate"><span class="pre">source</span></code> å‘½ä»¤ä» <code class="docutils literal notranslate"><span class="pre">scripts/models/glm4-9B.sh</span></code> æ–‡ä»¶ä¸­åŠ è½½æ¨¡å‹é…ç½®ã€‚è¿™äº›é…ç½®å‡ä¸º Megatron æ‰€éœ€çš„è¶…å‚æ•°ã€‚ç”±äº Megatron æ— æ³•ç›´æ¥ä»æ£€æŸ¥ç‚¹ï¼ˆcheckpointï¼‰ä¸­è¯»å–æ¨¡å‹é…ç½®ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨æŒ‡å®šã€‚æˆ‘ä»¬åœ¨ <code class="docutils literal notranslate"><span class="pre">scripts/models/</span></code> ç›®å½•ä¸‹æä¾›äº†ä¸€äº›å¸¸ç”¨æ¨¡å‹çš„é…ç½®ç¤ºä¾‹ã€‚</p>
<blockquote>
<div><p>âš ï¸ <strong>æ³¨æ„</strong>ï¼š
è¯·åŠ¡å¿…æ£€æŸ¥æ¨¡å‹é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼ˆå¦‚ <code class="docutils literal notranslate"><span class="pre">--rotary-base</span></code>ï¼‰æ˜¯å¦ä¸æ‚¨å½“å‰ä½¿ç”¨çš„æ¨¡å‹å®Œå…¨åŒ¹é…ã€‚åŒä¸€æ¨¡å‹ç»“æ„çš„ä¸åŒç‰ˆæœ¬å¯èƒ½ä½¿ç”¨ä¸åŒçš„é…ç½®å€¼ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œæ‚¨å¯ä»¥åœ¨ <code class="docutils literal notranslate"><span class="pre">source</span></code> ä¹‹åç›´æ¥è¦†ç›–ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_DIR</span><span class="si">}</span><span class="s2">/models/glm4-9B.sh&quot;</span>
<span class="nv">MODEL_ARGS</span><span class="o">+=(</span>--rotary-base<span class="w"> </span><span class="m">10000</span><span class="o">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="ckpt-args">
<h3>CKPT_ARGS: æ£€æŸ¥ç‚¹ä¸è·¯å¾„å‚æ•°<a class="headerlink" href="#ckpt-args" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CKPT_ARGS</span><span class="o">=(</span>
<span class="w">   </span><span class="c1"># ç”¨äºåŠ è½½ tokenizer ç­‰å…¶ä»–ä¿¡æ¯ï¼Œå®é™…ä¸Šä¸ä¼šä½¿ç”¨ hf è·¯å¾„ä¸­çš„æ¨¡å‹æƒé‡å‚æ•°</span>
<span class="w">   </span>--hf-checkpoint<span class="w"> </span>/root/GLM-Z1-9B-0414
<span class="w">   </span><span class="c1"># å‚è€ƒæ¨¡å‹ (Reference Model) çš„ Megatron æ ¼å¼æ£€æŸ¥ç‚¹</span>
<span class="w">   </span>--ref-load<span class="w"> </span>/root/GLM-Z1-9B-0414_torch_dist
<span class="w">   </span><span class="c1"># Actor æ¨¡å‹çš„åŠ è½½è·¯å¾„ã€‚è‹¥ä¸ºç©ºï¼Œåˆ™ä» --ref-load åŠ è½½</span>
<span class="w">   </span>--load<span class="w"> </span>/root/GLM-Z1-9B-0414_slime/
<span class="w">   </span><span class="c1"># è®­ç»ƒè¿‡ç¨‹ä¸­æ¨¡å‹çš„ä¿å­˜è·¯å¾„</span>
<span class="w">   </span>--save<span class="w"> </span>/root/GLM-Z1-9B-0414_slime/
<span class="w">   </span><span class="c1"># æ¨¡å‹ä¿å­˜é—´éš”ï¼ˆæ­¥æ•°ï¼‰</span>
<span class="w">   </span>--save-interval<span class="w"> </span><span class="m">20</span>
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="rollout-args-rollout">
<h3>ROLLOUT_ARGS: æ•°æ®ç”Ÿæˆï¼ˆRolloutï¼‰å‚æ•°<a class="headerlink" href="#rollout-args-rollout" title="Link to this heading">#</a></h3>
<p>æ•´ä¸ªè®­ç»ƒæµç¨‹å¯è§†ä¸ºä¸€ä¸ª <strong>â€œæ•°æ®é‡‡æ · â†’ æƒé‡æ›´æ–°â€</strong> çš„é—­ç¯ã€‚</p>
<p><strong>é˜¶æ®µä¸€ï¼šæ•°æ®é‡‡æ · (Rollout)</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--rollout-batch-size</span></code>ï¼šå®šä¹‰æ¯è½®é‡‡æ ·çš„ <strong>Prompt æ•°é‡</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--n-samples-per-prompt</span></code>ï¼šå®šä¹‰æ¯ä¸ª Prompt ç”Ÿæˆçš„ <strong>å›å¤æ•°é‡</strong> (ç”¨äº GRPO ç±»ä¼¼ç®—æ³•)</p></li>
</ul>
<blockquote>
<div><p>ä¸¤è€…ç›¸ä¹˜ï¼Œå†³å®šäº† <strong>å•è½®é‡‡æ ·äº§ç”Ÿçš„æ€»æ ·æœ¬æ•°</strong>ã€‚</p>
</div></blockquote>
<p><strong>é˜¶æ®µäºŒï¼šæ¨¡å‹è®­ç»ƒ (Training)</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--global-batch-size</span></code>ï¼šå®šä¹‰ <strong>æ‰§è¡Œä¸€æ¬¡å‚æ•°æ›´æ–°ï¼ˆoptimizer.stepï¼‰</strong> æ‰€éœ€çš„æ ·æœ¬é‡</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--num-steps-per-rollout</span></code>ï¼šå®šä¹‰ä½¿ç”¨å½“å‰é‡‡æ ·æ•°æ®ï¼Œ<strong>æ€»å…±æ‰§è¡Œå¤šå°‘æ¬¡å‚æ•°æ›´æ–°</strong>  (æˆ‘ä»¬é»˜è®¤ä¸º 1ï¼Œä½¿ç”¨ on-policy è®­ç»ƒ)</p></li>
</ul>
<blockquote>
<div><p>ä¸¤è€…ç›¸ä¹˜ï¼Œå†³å®šäº† <strong>å•è½®è®­ç»ƒæ¶ˆè€—çš„æ€»æ ·æœ¬æ•°</strong>ã€‚</p>
</div></blockquote>
<blockquote>
<div><p>âš ï¸ è¿™é‡Œçš„ <strong>å‚æ•°æ›´æ–°</strong> æŒ‡è®­ç»ƒç¯èŠ‚çš„ optimizer.step()ï¼Œä¸åŒäºè®­ç»ƒå¼•æ“å‘æ¨ç†å¼•æ“å‘èµ·çš„æƒé‡åŒæ­¥(Weight Sync)ã€‚</p>
</div></blockquote>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯è½®çš„â€œäº§å‡ºâ€ä¸â€œæ¶ˆè€—â€å¿…é¡»ç›¸ç­‰ï¼Œéµå¾ªä»¥ä¸‹çº¦æŸï¼š
<strong><code class="docutils literal notranslate"><span class="pre">(rollout-batch-size</span> <span class="pre">Ã—</span> <span class="pre">n-samples-per-prompt)</span> <span class="pre">=</span> <span class="pre">(global-batch-size</span> <span class="pre">Ã—</span> <span class="pre">num-steps-per-rollout)</span></code></strong></p>
<ul class="simple">
<li><p>åœ¨ slime ä¸­ï¼Œå¦‚æœè®¾ç½®äº† <code class="docutils literal notranslate"><span class="pre">--num-steps-per-rollout</span></code> ï¼Œ<code class="docutils literal notranslate"><span class="pre">--global-batch-size</span></code> æœªè®¾ç½®åˆ™ä¼šè¢«è‡ªåŠ¨è®¾ç½®ï¼Œè®¾ç½®äº†åˆ™ä¼šè¢«ç”¨ä¸Šè¿°å…¬å¼æ ¡éªŒã€‚</p></li>
</ul>
<p><strong>è®­ç»ƒæµç¨‹æ¬¡æ•°æ§åˆ¶</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--num-rollout</span></code>: æ§åˆ¶æ•´ä¸ª <strong>â€œé‡‡æ ·â†’è®­ç»ƒâ€</strong> å¾ªç¯çš„<strong>æ€»æ‰§è¡Œè½®æ¬¡</strong>ã€‚</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ROLLOUT_ARGS</span><span class="o">=(</span>
<span class="w">   </span><span class="c1"># Prompt æ•°æ®é›†ï¼ŒJSONL æ ¼å¼</span>
<span class="w">   </span>--prompt-data<span class="w"> </span>/root/dapo-math-17k/dapo-math-17k.jsonl
<span class="w">   </span>--input-key<span class="w"> </span>prompt
<span class="w">   </span>--label-key<span class="w"> </span>label
<span class="w">   </span><span class="c1"># è‹¥ Prompt çš„ `input_key` æ˜¯ OpenAI message æ ¼å¼ï¼Œåˆ™åº”ç”¨ Chat Template</span>
<span class="w">   </span>--apply-chat-template
<span class="w">   </span><span class="c1"># æ˜¯å¦åœ¨ Rollout é˜¶æ®µæ‰“ä¹±æ•°æ®</span>
<span class="w">   </span>--rollout-shuffle

<span class="w">   </span><span class="c1"># Reward Model ç±»å‹ã€‚slime å†…ç½®å¤šç§ç±»å‹ï¼Œä¹Ÿæ”¯æŒé€šè¿‡ --custom-rm-path è‡ªå®šä¹‰</span>
<span class="w">   </span>--rm-type<span class="w"> </span>deepscaler

<span class="w">   </span><span class="c1"># è¿™äº”ä¸ªå‚æ•°æ¥æ§åˆ¶ rollout ä¸ train çš„å…³ç³»</span>
<span class="w">   </span>--num-rollout<span class="w"> </span><span class="m">3000</span>
<span class="w">   </span>--rollout-batch-size<span class="w"> </span><span class="m">16</span>
<span class="w">   </span>--n-samples-per-prompt<span class="w"> </span><span class="m">8</span>
<span class="w">   </span>--num-steps-per-rollout<span class="w"> </span><span class="m">1</span>
<span class="w">   </span>--global-batch-size<span class="w"> </span><span class="m">128</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1"># Rollout é‡‡æ ·å‚æ•°</span>
<span class="w">   </span>--rollout-max-response-len<span class="w"> </span><span class="m">8192</span>
<span class="w">   </span>--rollout-temperature<span class="w"> </span><span class="m">0</span>.8

<span class="w">   </span><span class="c1"># å¯¹ rollout é˜¶æ®µæ”¶é›†çš„æ•°æ®è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å®ƒç¡®ä¿äº†åˆ†é…åˆ°æ¯ä¸ªè®­ç»ƒè¿›ç¨‹ï¼ˆDP rankï¼‰çš„è®¡ç®—ä»»åŠ¡é‡å¤§è‡´ç›¸ç­‰ï¼Œå¯èƒ½å¯¹è®­ç»ƒé€Ÿåº¦æœ‰å¥½å¤„</span>
<span class="w">   </span>--balance-data
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="eval-args">
<h3>EVAL_ARGS: è¯„ä¼°å‚æ•°<a class="headerlink" href="#eval-args" title="Link to this heading">#</a></h3>
<p>è¯„ä¼°è¿‡ç¨‹ä¼šç»§æ‰¿å¤§éƒ¨åˆ† Rollout å‚æ•°ï¼Œä½†æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°è¿›è¡Œè¦†ç›–ï¼Œä»¥å®ç°ä¸è®­ç»ƒä¸åŒçš„è¯„ä¼°ç­–ç•¥ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">EVAL_ARGS</span><span class="o">=(</span>
<span class="w">   </span><span class="c1"># è¯„ä¼°é—´éš”ï¼ˆRollout æ•°ï¼‰</span>
<span class="w">   </span>--eval-interval<span class="w"> </span><span class="m">5</span>
<span class="w">   </span><span class="c1"># è¯„ä¼°ç”¨çš„ Prompt æ•°æ®é›†</span>
<span class="w">   </span>--eval-prompt-data<span class="w"> </span>aime<span class="w"> </span>/root/aime-2024/aime-2024.jsonl
<span class="w">   </span><span class="c1"># æ¯ä¸ªè¯„ä¼° Prompt çš„é‡‡æ ·æ•°é‡</span>
<span class="w">   </span>--n-samples-per-eval-prompt<span class="w"> </span><span class="m">16</span>
<span class="w">   </span><span class="c1"># è¯„ä¼°æ—¶æœ€å¤§å“åº”é•¿åº¦</span>
<span class="w">   </span>--eval-max-response-len<span class="w"> </span><span class="m">16384</span>
<span class="w">   </span><span class="c1"># è¯„ä¼°æ—¶é‡‡æ ·å‚æ•°</span>
<span class="w">   </span>--eval-top-p<span class="w"> </span><span class="m">0</span>.7
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="perf-args">
<h3>PERF_ARGS: æ€§èƒ½ä¸å¹¶è¡Œå‚æ•°<a class="headerlink" href="#perf-args" title="Link to this heading">#</a></h3>
<p>è¿™éƒ¨åˆ†ä¸»è¦åŒ…å« Megatron çš„å¹¶è¡Œé…ç½®ã€‚<code class="docutils literal notranslate"><span class="pre">--use-dynamic-batch-size</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">--max-tokens-per-gpu</span></code> æ˜¯ slime æ·»åŠ çš„ç‰¹æœ‰ä¼˜åŒ–ã€‚</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--max-tokens-per-gpu</span></code>: æ¯å¼  GPU å¤„ç†çš„æœ€å¤§ Token æ•°ã€‚å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†ï¼ˆ<code class="docutils literal notranslate"><span class="pre">use_dynamic_batch_size</span></code>ï¼‰åï¼Œç³»ç»Ÿä¼šæ™ºèƒ½åœ°å°†é•¿çŸ­ä¸ä¸€çš„æ ·æœ¬æ‰“åŒ…ï¼Œä½¿æ¯ä¸ª micro-batch çš„æ€» Token æ•°æ¥è¿‘æ­¤é™åˆ¶ï¼Œä»è€Œæå‡è®­ç»ƒæ•ˆç‡ã€‚å¦‚æœå•ä¸ªæ ·æœ¬é•¿åº¦è¶…è¿‡è¯¥å€¼ï¼Œå®ƒå°†ç‹¬ç«‹å½¢æˆä¸€ä¸ª batchã€‚åœ¨ä¸Šä¸‹æ–‡å¹¶è¡Œï¼ˆCPï¼‰æ¨¡å¼ä¸‹ï¼Œ<code class="docutils literal notranslate"><span class="pre">N</span></code> å¼  CP å¡å…±äº« <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">*</span> <span class="pre">max_tokens_per_gpu</span></code> çš„æ€»é•¿åº¦ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--use-dynamic-batch-size</span></code>: å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†ã€‚æ­¤æ—¶ä¼šå¿½ç•¥ <code class="docutils literal notranslate"><span class="pre">--micro-batch-size</span></code>ã€‚</p></li>
</ul>
<blockquote>
<div><p>ğŸ’¡ <strong>æç¤º</strong>ï¼š
slime æ€»æ˜¯ä¼šé€šè¿‡ data packing çš„æ–¹æ³•è®­ç»ƒæ¨¡å‹ï¼Œå¹¶ä¸”ä¸¥æ ¼ä¿è¯ per sample loss æˆ– per token loss æ˜¯æ­£ç¡®çš„ã€‚å› æ­¤ï¼Œå¼€å¯ dynamic batch size ä¸ä¼šå¯¹ loss è®¡ç®—æœ‰å½±å“ï¼Œå¼ºçƒˆæ¨èå¼€å¯ã€‚</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PERF_ARGS</span><span class="o">=(</span>
<span class="w">   </span>--tensor-model-parallel-size<span class="w"> </span><span class="m">2</span>
<span class="w">   </span>--sequence-parallel
<span class="w">   </span>--pipeline-model-parallel-size<span class="w"> </span><span class="m">1</span>
<span class="w">   </span>--context-parallel-size<span class="w"> </span><span class="m">2</span>
<span class="w">   </span>--expert-model-parallel-size<span class="w"> </span><span class="m">1</span>
<span class="w">   </span>--expert-tensor-parallel-size<span class="w"> </span><span class="m">1</span>

<span class="w">   </span>--recompute-granularity<span class="w"> </span>full
<span class="w">   </span>--recompute-method<span class="w"> </span>uniform
<span class="w">   </span>--recompute-num-layers<span class="w"> </span><span class="m">1</span>

<span class="w">   </span><span class="c1"># --micro-batch-size 1 # å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†åæ­¤é¡¹è¢«å¿½ç•¥</span>
<span class="w">   </span>--use-dynamic-batch-size
<span class="w">   </span>--max-tokens-per-gpu<span class="w"> </span><span class="m">4608</span>
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="grpo-args-grpo">
<h3>GRPO_ARGS: GRPO ç®—æ³•å‚æ•°<a class="headerlink" href="#grpo-args-grpo" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--use-kl-loss</span></code>: å¯ç”¨æ­¤é€‰é¡¹å°†åŠ è½½ä¸€ä¸ªå‚è€ƒæ¨¡å‹ï¼ˆReference Modelï¼‰ï¼Œå¹¶è®¡ç®—å½“å‰æ¨¡å‹ä¸å‚è€ƒæ¨¡å‹ä¹‹é—´çš„ KL æ•£åº¦ï¼ˆKL Divergenceï¼‰ä½œä¸ºä¸€é¡¹ç›‘æ§æŒ‡æ ‡ã€‚KL æ•£åº¦æ˜¯å¦è¢«è®¡å…¥æœ€ç»ˆçš„è®­ç»ƒæŸå¤±ï¼ˆLossï¼‰ï¼Œå–å†³äº <code class="docutils literal notranslate"><span class="pre">--kl-loss-coef</span></code> å‚æ•°ã€‚è‹¥è¯¥å‚æ•°è®¾ç½®ä¸º 0ï¼Œåˆ™ KL æ•£åº¦ä»…ä½œä¸ºè§‚æµ‹æŒ‡æ ‡æ˜¾ç¤ºï¼Œè€Œä¸ä¼šå‚ä¸æŸå¤±è®¡ç®—ã€‚</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">GRPO_ARGS</span><span class="o">=(</span>
<span class="w">   </span>--advantage-estimator<span class="w"> </span>grpo
<span class="w">   </span>--use-kl-loss
<span class="w">   </span>--kl-loss-coef<span class="w"> </span><span class="m">0</span>.00
<span class="w">   </span>--kl-loss-type<span class="w"> </span>low_var_kl
<span class="w">   </span>--entropy-coef<span class="w"> </span><span class="m">0</span>.00
<span class="w">   </span>--eps-clip<span class="w"> </span><span class="m">0</span>.2
<span class="w">   </span>--eps-clip-high<span class="w"> </span><span class="m">0</span>.28
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="optimizer-args">
<h3>OPTIMIZER_ARGS: ä¼˜åŒ–å™¨å‚æ•°<a class="headerlink" href="#optimizer-args" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">OPTIMIZER_ARGS</span><span class="o">=(</span>
<span class="w">   </span>--optimizer<span class="w"> </span>adam
<span class="w">   </span>--lr<span class="w"> </span>1e-6
<span class="w">   </span>--lr-decay-style<span class="w"> </span>constant
<span class="w">   </span>--weight-decay<span class="w"> </span><span class="m">0</span>.1
<span class="w">   </span>--adam-beta1<span class="w"> </span><span class="m">0</span>.9
<span class="w">   </span>--adam-beta2<span class="w"> </span><span class="m">0</span>.98
<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="sglang-args-sglang">
<h3>SGLANG_ARGS: SGLang æœåŠ¡å‚æ•°<a class="headerlink" href="#sglang-args-sglang" title="Link to this heading">#</a></h3>
<p>è¿™éƒ¨åˆ†å‚æ•°ç”¨äºé…ç½® SGLang æ¨ç†æœåŠ¡ã€‚</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--rollout-num-gpus-per-engine</span></code>: åŸºæœ¬ç­‰åŒäº SGLang çš„ <code class="docutils literal notranslate"><span class="pre">tp_size</span></code>ã€‚</p></li>
<li><p>å…¶ä»– SGLang å‚æ•°å¯ä»¥é€šè¿‡æ·»åŠ  <code class="docutils literal notranslate"><span class="pre">--sglang-</span></code> å‰ç¼€ä¼ é€’ç»™ slime,  slime ä¼šè‡ªåŠ¨é€ä¼ ç»™ SGLangã€‚ä¾‹å¦‚ï¼Œè¦è®¾ç½® SGLang çš„ <code class="docutils literal notranslate"><span class="pre">--log-level</span> <span class="pre">INFO</span></code> å‚æ•°ï¼Œåªéœ€ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">--sglang-log-level</span> <span class="pre">INFO</span></code> å³å¯ã€‚</p></li>
</ul>
<blockquote>
<div><p>âš ï¸ <strong>æ³¨æ„</strong>ï¼š
slime ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">sgl-router</span></code> è°ƒåº¦å¤šä¸ª SGLang Serverã€‚åœ¨ä¸å¼€å¯ DP Attention çš„æƒ…å†µä¸‹ï¼Œ <code class="docutils literal notranslate"><span class="pre">dp_size</span></code> ä¼šé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">rollout-num-gpus</span> <span class="pre">/</span> <span class="pre">rollout-num-gpus-per-engine</span></code> è®¡ç®—å¾—åˆ°ã€‚</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SGLANG_ARGS</span><span class="o">=(</span>
<span class="w">   </span>--rollout-num-gpus-per-engine<span class="w"> </span><span class="m">2</span>
<span class="o">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>ç‰¹æ€§ä»‹ç»<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<section id="colocated-actor-and-rollout">
<h3>Colocated Actor and Rollout<a class="headerlink" href="#colocated-actor-and-rollout" title="Link to this heading">#</a></h3>
<p>åœ¨é»˜è®¤çš„é…ç½®ä¸‹ï¼Œè®­ç»ƒï¼ˆActorï¼‰å’Œæ¨ç†ï¼ˆRolloutï¼‰çš„èµ„æºæ˜¯åˆ†å¼€æŒ‡å®šçš„ï¼Œé€šè¿‡ ray ç»™è®­ç»ƒéƒ¨åˆ†åˆ†é… <code class="docutils literal notranslate"><span class="pre">actor_num_nodes</span> <span class="pre">*</span> <span class="pre">actor_num_gpus_per_node</span></code> å¼  GPUï¼Œç»™æ¨ç†åˆ†é… <code class="docutils literal notranslate"><span class="pre">rollout_num_gpus</span></code> å¼  GPUï¼Œä¹Ÿå³è®­æ¨åˆ†ç¦»ã€‚</p>
<p><strong>æ ‡å‡†ï¼ˆåˆ†ç¦»ï¼‰é…ç½®</strong>ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray<span class="w"> </span>job<span class="w"> </span>submit<span class="w"> </span>...<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--<span class="w"> </span>python3<span class="w"> </span>train.py<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--actor-num-nodes<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--actor-num-gpus-per-node<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--rollout-num-gpus<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>...
</pre></div>
</div>
<p>ä¸Šè¿°é…ç½®ä¸­ï¼ŒActor ä½¿ç”¨ 4 å¼ å¡ï¼ŒRollout ä¹Ÿä½¿ç”¨ 4 å¼ å¡ï¼Œä¸¤è€…å¹¶è¡Œè¿è¡Œã€‚</p>
<p><strong>è®­æ¨ä¸€ä½“åŒ–ï¼ˆColocatedï¼‰é…ç½®</strong>ï¼š
è¦å°†è®­ç»ƒå’Œæ¨ç†éƒ¨ç½²åœ¨åŒä¸€ç»„ GPU ä¸Šï¼Œè¯·æ·»åŠ  <code class="docutils literal notranslate"><span class="pre">--colocate</span></code> å‚æ•°ï¼Œå¼€å¯åä¼šå¿½ç•¥ <code class="docutils literal notranslate"><span class="pre">--rollout-num-gpus</span></code> è®©è®­ç»ƒå’Œæ¨ç†çš„å¡æ•°ç›¸ç­‰ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray<span class="w"> </span>job<span class="w"> </span>submit<span class="w"> </span>...<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--<span class="w"> </span>python3<span class="w"> </span>train.py<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--actor-num-nodes<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--actor-num-gpus-per-node<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--colocate<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>...
</pre></div>
</div>
<p>æ­¤æ—¶ï¼Œè®­ç»ƒå’Œæ¨ç†å°†å…±äº«å…¨éƒ¨ 8 å¼  GPUã€‚</p>
<blockquote>
<div><p>âš ï¸ <strong>æ³¨æ„</strong>ï¼š
åœ¨è®­æ¨ä¸€ä½“åŒ–æ¨¡å¼ä¸‹ï¼ŒMegatron åˆå§‹åŒ–åæ‰èƒ½è¢« offload æ‰ï¼Œä¼šå æ®ä¸€å®šé‡çš„æ˜¾å­˜ã€‚æ‚¨éœ€è¦é€šè¿‡è°ƒæ•´ <code class="docutils literal notranslate"><span class="pre">--sglang-mem-fraction-static</span></code> å‚æ•°æ¥é™ä½ SGLang çš„æ˜¾å­˜å ç”¨æ¯”ä¾‹ï¼Œä»¥é¿å…æ˜¾å­˜ä¸è¶³ã€‚é€šå¸¸æˆ‘ä»¬å»ºè®®ä¸º 0.8ã€‚</p>
</div></blockquote>
<blockquote>
<div><p>æ­¤å¤–ï¼Œ<a class="reference external" href="https://github.com/fzyzcjy/torch_memory_saver">torch_memory_saver</a> é‡Œé¢çš„ä¸€äº›ä¼˜åŒ–åªèƒ½åœ¨è®­æ¨ä¸€ä½“æ¨¡å¼ä¸­ä½¿ç”¨ï¼Œå› ä¸ºéœ€è¦é‡Šæ”¾ GPU æ˜¾å­˜ã€‚è®­æ¨åˆ†ç¦»æ¨¡å¼æš‚ä¸æ”¯æŒã€‚</p>
</div></blockquote>
</section>
<section id="dynamic-sampling">
<h3>Dynamic Sampling<a class="headerlink" href="#dynamic-sampling" title="Link to this heading">#</a></h3>
<p>slime æ”¯æŒæ›´å¤æ‚çš„é‡‡æ ·ç­–ç•¥ï¼Œä¾‹å¦‚ <a class="reference external" href="https://dapo-sia.github.io/">DAPO</a> ä¸­ä½¿ç”¨çš„åŠ¨æ€é‡‡æ ·ã€‚è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œéœ€é…ç½®ä»¥ä¸‹å‚æ•°ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">   </span>--over-sampling-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--dynamic-sampling-filter-path<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>slime.rollout.filter_hub.dynamic_sampling_filters.check_reward_nonzero_std
</pre></div>
</div>
<p>è¿™é‡Œ <code class="docutils literal notranslate"><span class="pre">over_sampling_batch_size</span></code> éœ€è¦å¤§äº <code class="docutils literal notranslate"><span class="pre">rollout_batch_size</span></code>ï¼Œä¾‹å¦‚é…ç½®ä¸ºï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">   </span>--rollout-batch-size<span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--n-samples-per-prompt<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--over-sampling-batch-size<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p>é‚£ä¹ˆ sampling ä¼šç›´æ¥é‡‡æ · 64 æ¡ promptï¼Œæ¯æ¡ prompt é‡‡æ · 8 æ¬¡ã€‚å› ä¸º slime å†…éƒ¨è¿›è¡Œçš„æ˜¯å¼‚æ­¥é‡‡æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå…ˆåè·å¾—æ¯ä¸ª prompt çš„ 8 æ¡å›å¤ã€‚åœ¨æ”¶åˆ°å›å¤æ—¶ï¼Œä¼šç”¨ <code class="docutils literal notranslate"><span class="pre">dynamic_sampling_filter_path</span></code> å¯¹åº”çš„å‡½æ•°è¿›è¡Œç­›é€‰ï¼Œå¦‚æœé€šè¿‡ï¼Œåˆ™ç•™ä¸‹è¿™ 8 æ¡æ•°æ®ï¼Œå¦åˆ™åˆ™ä¸¢æ‰ã€‚</p>
<p>ç¤ºä¾‹ä¸­çš„è¿‡æ»¤å‡½æ•° <code class="docutils literal notranslate"><span class="pre">check_reward_nonzero_std</span></code> ä¼šæ£€æŸ¥ä¸€ç»„æ ·æœ¬çš„å¥–åŠ±ï¼ˆrewardï¼‰æ ‡å‡†å·®æ˜¯å¦å¤§äºé›¶ï¼Œç¡®ä¿ç•™ä¸‹çš„æ¯ç»„æ ·æœ¬å…¶å¥–åŠ±åˆ†æ•°éƒ½å­˜åœ¨å·®å¼‚ï¼Œä»è€Œé¿å…æ•°æ®è¿‡äºå•ä¸€ï¼Œæå‡äº†æ•°æ®çš„å¤šæ ·æ€§ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">check_reward_nonzero_std</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Sample</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">reward</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>å¦‚æœè¿‡æ»¤å‡½æ•°éå¸¸ä¸¥æ ¼ï¼Œå¯¼è‡´å¤§é‡ prompt ç»„è¢«ä¸¢å¼ƒï¼Œç³»ç»Ÿä¼šç›‘æ§ <code class="docutils literal notranslate"> <span class="pre">remaining_batch_size</span></code> ä¸­å¾…å¤„ç†çš„ä»»åŠ¡æ•°é‡ã€‚ä¸€æ—¦å¾…å¤„ç†çš„ä»»åŠ¡æ•°å› ä¸¢å¼ƒè¿‡å¤šè€Œé™è‡³ç›®æ ‡æ•° (32) ä»¥ä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘æ–°ä¸€è½®çš„è¿‡é‡‡æ ·ï¼Œå†æ¬¡è¯·æ±‚  <code class="docutils literal notranslate"><span class="pre">over_sampling_batch_size</span></code> (64) ä¸ªæ–°çš„ prompt é‡å¤ä¸Šè¿°æµç¨‹ã€‚</p>
</section>
<section id="partial-rollout">
<h3>Partial Rollout<a class="headerlink" href="#partial-rollout" title="Link to this heading">#</a></h3>
<p>åœ¨åŠ¨æ€é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œå¤§é‡è¯·æ±‚å¯èƒ½ä¼šè¢«æå‰ä¸­æ­¢ï¼ˆabortï¼‰ï¼Œé€ æˆè®¡ç®—èµ„æºæµªè´¹ã€‚é€šè¿‡å¯ç”¨ <code class="docutils literal notranslate"><span class="pre">--partial-rollout</span></code> å‚æ•°ï¼Œå¯ä»¥å°†è¿™äº›ç”Ÿæˆåˆ°ä¸€åŠçš„æ ·æœ¬ç¼“å­˜èµ·æ¥ï¼Œåœ¨ä¸‹ä¸€ä¸ª Rollout é˜¶æ®µç»§ç»­ç”Ÿæˆï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</p>
<p>æ‚¨è¿˜å¯ä»¥é€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--buffer-filter-path</span></code> è‡ªå®šä¹‰ä»ç¼“å­˜ä¸­æå–æ•°æ®çš„ç­–ç•¥ã€‚é»˜è®¤ç­–ç•¥æ˜¯ <code class="docutils literal notranslate"><span class="pre">pop_first</span></code>ï¼Œå³æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæå–æ‰€éœ€æ•°é‡çš„æ ·æœ¬ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pop_first</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Sample</span><span class="p">]],</span> <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Sample</span><span class="p">]]:</span>
    <span class="n">num_to_pop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">num_to_pop</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">num_to_pop</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">samples</span>
</pre></div>
</div>
<p>å³æ¯æ¬¡å–å‡ºå‰ <code class="docutils literal notranslate"><span class="pre">num_samples</span></code> ä¸ª prompt å¯¹åº”çš„ <code class="docutils literal notranslate"><span class="pre">num_samples</span> <span class="pre">*</span> <span class="pre">n_samples_per_prompt</span></code> æ¡æ•°æ®ã€‚</p>
<blockquote>
<div><p>ğŸ’¡ <strong>æç¤º</strong>ï¼š
æ¯æ¡ partial rollout sample çš„ <code class="docutils literal notranslate"><span class="pre">sample.metadata</span></code> ä¸­å­˜å‚¨äº†ç¬¬ä¸€æ¬¡è¿›è¡Œç”Ÿæˆçš„ rollout idï¼Œå¯ä»¥ç”¨äºæ•°æ®è¿‡æ»¤ã€‚</p>
</div></blockquote>
</section>
<section id="bf16-fp8">
<h3>bf16 è®­ç»ƒ fp8 æ¨ç†<a class="headerlink" href="#bf16-fp8" title="Link to this heading">#</a></h3>
<p>slime ç›´æ¥æ”¯æŒ bf16 è®­ç»ƒï¼Œfp8 æ¨ç†ã€‚å¯¹äº Qwen3-4B æ¨¡å‹ï¼Œåªéœ€è¦ä¸‹è½½å¦‚ä¸‹æ¨¡å‹ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hf<span class="w"> </span>download<span class="w"> </span>Qwen/Qwen3-4B-FP8<span class="w"> </span>--local-dir<span class="w"> </span>/root/Qwen3-4B-FP8
</pre></div>
</div>
<p>å¹¶å°† <code class="docutils literal notranslate"><span class="pre">--hf-checkpoint</span></code> æ›¿æ¢ä¸ºï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c1"># ç”¨äºåŠ è½½ tokenizer ç­‰å…¶ä»–ä¿¡æ¯ï¼Œå®é™…ä¸Šä¸ä¼šä½¿ç”¨ hf è·¯å¾„ä¸­çš„æ¨¡å‹æƒé‡å‚æ•°</span>
<span class="w">   </span>--hf-checkpoint<span class="w"> </span>/root/Qwen3-4B-FP8

<span class="w">   </span><span class="c1">#  megatron checkpoint è¿˜éœ€è¦æ˜¯æœ€å¼€å§‹ç”¨ bf16 çš„ huggingface è½¬æ¢çš„ dist æƒé‡ï¼Œä¸å› ä¸º FP rollout è€Œå»åšä¿®æ”¹ã€‚</span>
<span class="w">   </span>--ref-load<span class="w"> </span>/root/Qwen3-4B_torch_dist
</pre></div>
</div>
<p>å³å¯è§¦å‘ fp8 æ¨ç†ã€‚ç›®å‰æˆ‘ä»¬ä¼šå°† bf16 æƒé‡ç›´æ¥ cast ä¸º fp8ï¼Œåç»­ä¼šé€æ¸æ·»åŠ å¯¹ç²¾åº¦å½±å“æ›´å°çš„é‡åŒ–æ–¹æ¡ˆã€‚</p>
<p>âš ï¸  è®­ç»ƒçš„ megatron checkpoint è¿˜éœ€è¦æ˜¯æœ€å¼€å§‹ç”¨ bf16 çš„ huggingface è½¬æ¢çš„ã€‚</p>
</section>
</section>
<section id="multiturn">
<h2>Multiturn é€‚é…<a class="headerlink" href="#multiturn" title="Link to this heading">#</a></h2>
<p>slime æ¡†æ¶é«˜åº¦å¯æ‰©å±•ï¼Œæ”¯æŒå¤æ‚çš„ Agent åœºæ™¯ï¼ˆå¦‚å¤šè½®äº¤äº’ä¸å·¥å…·è°ƒç”¨ï¼‰ã€‚å…¶æ ¸å¿ƒæœºåˆ¶æ˜¯é€šè¿‡è‡ªå®šä¹‰å‡½æ•°ï¼Œé‡å†™é»˜è®¤çš„æ•°æ®ç”Ÿæˆ (Rollout) ä¸å¥–åŠ±è®¡ç®— (Reward) é€»è¾‘ã€‚</p>
<p>æœ¬éƒ¨åˆ†ä»¥ä¸€ä¸ªåŸºäº <a class="reference external" href="https://github.com/PeterGriffinJin/Search-R1">Search-R1</a> çš„å®ç°ä¸ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•é€‚é… slime ä»¥æ”¯æŒå¤šè½®äº¤äº’ã€‚</p>
<section id="id7">
<h3>é€‚é…æ€è·¯æ€»ç»“<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>é€‚é… slime ä»¥æ”¯æŒå¤šè½®äº¤äº’ä¸»è¦åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol class="arabic simple">
<li><p><strong>æ•°æ®å‡†å¤‡</strong>ï¼šå°†å¤šè½®äº¤äº’æ•°æ®é›†é€‚é…ä¸º slime çš„ <code class="docutils literal notranslate"><span class="pre">Sample</span></code> å¯¹è±¡ã€‚å°†å¯¹è¯å†å²ã€çœŸå®æ ‡ç­¾ç­‰æ˜ å°„åˆ° <code class="docutils literal notranslate"><span class="pre">prompt</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">label</span></code> å­—æ®µï¼Œå¹¶å°†å·¥å…·å®šä¹‰ã€ä¸­é—´çŠ¶æ€ç­‰é¢å¤–ä¿¡æ¯å­˜å…¥ <code class="docutils literal notranslate"><span class="pre">metadata</span></code> å­—æ®µï¼Œä¾›åç»­å‡½æ•°è°ƒç”¨ã€‚</p></li>
<li><p><strong>å®ç°è‡ªå®šä¹‰ç”Ÿæˆå‡½æ•°</strong>ï¼šç¼–å†™å‡½æ•°æ¨¡æ‹Ÿâ€œæ¨¡å‹ç”ŸæˆåŠ¨ä½œ â†’ æ‰§è¡Œå·¥å…· â†’ æ‹¼æ¥è§‚å¯Ÿç»“æœâ€çš„äº¤äº’å¾ªç¯ï¼Œå¹¶æ­£ç¡®å¤„ç† Loss Maskingã€‚</p></li>
<li><p><strong>å®ç°è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°</strong>ï¼šç¼–å†™å‡½æ•°è¯„ä¼°å®Œæ•´çš„äº¤äº’è½¨è¿¹ï¼Œè¿”å›æœ€ç»ˆçš„å¥–åŠ±åˆ†æ•°ã€‚</p></li>
</ol>
</section>
<section id="id8">
<h3>æ•°æ®å‡†å¤‡ä¸æ˜ å°„<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>ä¸ºäº†å‘è‡ªå®šä¹‰å‡½æ•°ä¼ é€’å¤æ‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ‚¨éœ€è¦åœ¨<strong>æ•°æ®é¢„å¤„ç†é˜¶æ®µ</strong>å°±å°†æ‰€æœ‰ç›¸å…³çš„é¢å¤–å­—æ®µèšåˆèµ·æ¥ã€‚</p>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå°†æ•°æ®é›†ä¸­é™¤ <code class="docutils literal notranslate"><span class="pre">prompt</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">label</span></code> ä¹‹å¤–çš„æ‰€æœ‰é™„åŠ ä¿¡æ¯ï¼ˆå¦‚ <code class="docutils literal notranslate"><span class="pre">session_id</span></code>, <code class="docutils literal notranslate"><span class="pre">user_profile</span></code>, <code class="docutils literal notranslate"><span class="pre">tool_code</span></code> ç­‰ï¼‰åˆå¹¶ï¼Œæ„é€ æˆä¸€ä¸ª<strong>å•ä¸€çš„ã€ç»“æ„åŒ–çš„å­—æ®µ</strong>ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªåä¸º <code class="docutils literal notranslate"><span class="pre">metadata</span></code> çš„åˆ—ï¼Œå…¶å†…å®¹ä¸º JSON å­—ç¬¦ä¸²ï¼‰ã€‚</p>
</section>
<section id="metadata">
<h3>æ­¥éª¤ä¸€ï¼šåœ¨æ•°æ®é›†ä¸­æ„é€  <code class="docutils literal notranslate"><span class="pre">metadata</span></code> å­—æ®µ<a class="headerlink" href="#metadata" title="Link to this heading">#</a></h3>
<p>åœ¨è®­ç»ƒå¼€å§‹å‰ï¼Œæ‚¨éœ€è¦å¯¹åŸå§‹æ•°æ®é›†è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œæ‚¨çš„åŸå§‹æ•°æ®å¯èƒ½å¦‚ä¸‹ï¼š</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p>question</p></th>
<th class="head text-left"><p>final_answer</p></th>
<th class="head text-left"><p>session_id</p></th>
<th class="head text-left"><p>tool_code</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>&quot;...&quot;</p></td>
<td class="text-left"><p>&quot;...&quot;</p></td>
<td class="text-left"><p>&quot;sess_123&quot;</p></td>
<td class="text-left"><p>&quot;code_A&quot;</p></td>
</tr>
</tbody>
</table>
</div>
<p>æ‚¨éœ€è¦å°†å…¶è½¬æ¢ä¸ºï¼š</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p>question</p></th>
<th class="head text-left"><p>final_answer</p></th>
<th class="head text-left"><p>metadata</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>&quot;...&quot;</p></td>
<td class="text-left"><p>&quot;...&quot;</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">{&quot;session_id&quot;:</span> <span class="pre">&quot;sess_123&quot;,</span> <span class="pre">&quot;tool_code&quot;:</span> <span class="pre">&quot;code_A&quot;}</span></code></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id9">
<h3>æ­¥éª¤äºŒï¼šåœ¨è®­ç»ƒè„šæœ¬ä¸­æŒ‡å®šæ˜ å°„<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>å®Œæˆæ•°æ®å‡†å¤‡åï¼Œåœ¨è®­ç»ƒè„šæœ¬ä¸­ï¼Œé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">ROLLOUT_ARGS</span></code> å°†è¿™ä¸ªé¢„å¤„ç†å¥½çš„ <code class="docutils literal notranslate"><span class="pre">metadata</span></code> åˆ—æ˜ å°„åˆ° slime çš„ <code class="docutils literal notranslate"><span class="pre">Sample.metadata</span></code> å­—æ®µã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ROLLOUT_ARGS</span><span class="o">=(</span>
<span class="w">   </span><span class="c1"># 1. æŒ‡å®šé¢„å¤„ç†åçš„æ•°æ®é›†æ–‡ä»¶</span>
<span class="w">   </span>--prompt-data<span class="w"> </span>/root/nq_search/train_processed.json

<span class="w">   </span><span class="c1"># 2. å°† &quot;question&quot; åˆ—æ˜ å°„ä¸ºè¾“å…¥ prompt</span>
<span class="w">   </span>--prompt-key<span class="w"> </span>question

<span class="w">   </span><span class="c1"># 3. å°† &quot;final_answer&quot; åˆ—æ˜ å°„ä¸ºè¯„ä¼°æ ‡ç­¾</span>
<span class="w">   </span>--label-key<span class="w"> </span>final_answer

<span class="w">   </span><span class="c1"># 4. å°†é¢„å…ˆæ„é€ å¥½çš„ &quot;metadata&quot; åˆ—åŠ è½½åˆ° Sample.metadata</span>
<span class="w">   </span><span class="c1">#    slime ä¼šè‡ªåŠ¨å°†å…¶è§£æä¸º Python å­—å…¸</span>
<span class="w">   </span>--metadata-key<span class="w"> </span>metadata
<span class="o">)</span>
</pre></div>
</div>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å°±å¯ä»¥åœ¨è‡ªå®šä¹‰çš„ <code class="docutils literal notranslate"><span class="pre">generate</span></code> æˆ– <code class="docutils literal notranslate"><span class="pre">reward</span></code> å‡½æ•°ä¸­ï¼Œé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">sample.metadata['session_id']</span></code> ç­‰æ–¹å¼ï¼Œæ–¹ä¾¿åœ°è®¿é—®åˆ°æ‰€æœ‰é¢„å…ˆå‡†å¤‡å¥½çš„ç»“æ„åŒ–ä¿¡æ¯ã€‚</p>
</section>
<section id="id10">
<h3>ç¼–å†™è‡ªå®šä¹‰ç”Ÿæˆå‡½æ•°<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>é¦–å…ˆï¼Œé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--custom-generate-function-path</span></code> å‚æ•°æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„å¼‚æ­¥ Python å‡½æ•°ã€‚</p>
<p><strong>å‡½æ•°ç­¾å</strong>: <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span> <span class="pre">generate(args,</span> <span class="pre">sample:</span> <span class="pre">Sample,</span> <span class="pre">sampling_params)</span> <span class="pre">-&gt;</span> <span class="pre">Sample:</span></code></p>
<p><strong>æ ¸å¿ƒå®ç°è¦ç‚¹</strong>:</p>
<ol class="arabic simple">
<li><p><strong>æ„å»ºäº¤äº’å¾ªç¯</strong>: åˆ›å»ºå¾ªç¯ä»¥æ§åˆ¶æœ€å¤§äº¤äº’è½®æ¬¡ï¼ˆå¦‚ <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">_</span> <span class="pre">in</span> <span class="pre">range(max_turns):</span></code>ï¼‰ã€‚</p></li>
<li><p><strong>è°ƒç”¨æ¨¡å‹ç”ŸæˆåŠ¨ä½œ</strong>: æ¯è½®å¾ªç¯ä¸­ï¼Œè°ƒç”¨ SGLang æœåŠ¡ï¼Œè®©æ¨¡å‹æ ¹æ®å½“å‰å¯¹è¯å†å²ç”Ÿæˆä¸‹ä¸€æ­¥åŠ¨ä½œï¼ˆå¦‚ <code class="docutils literal notranslate"><span class="pre">&lt;search&gt;query&lt;/search&gt;</span></code>ï¼‰ã€‚</p></li>
<li><p><strong>è§£æå¹¶æ‰§è¡ŒåŠ¨ä½œ</strong>: è§£ææ¨¡å‹è¾“å‡ºï¼Œè¯†åˆ«åŠ¨ä½œä¸å‚æ•°ï¼Œå¹¶è°ƒç”¨å¤–éƒ¨å·¥å…·æˆ– APIï¼ˆå¦‚ Google æœç´¢ï¼‰ã€‚</p></li>
<li><p><strong>æ„å»ºè§‚å¯Ÿç»“æœ</strong>: å°†å·¥å…·è¿”å›çš„ç»“æœæ ¼å¼åŒ–åï¼Œè¿½åŠ åˆ°å¯¹è¯å†å²ä¸­ï¼Œä½œä¸ºä¸‹ä¸€è½®çš„è¾“å…¥ã€‚</p></li>
<li><p><strong>å¤„ç† Loss Masking</strong>: è¿™æ˜¯ Agent è®­ç»ƒçš„å…³é”®ã€‚</p>
<ul class="simple">
<li><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š <code class="docutils literal notranslate"><span class="pre">loss_mask</span></code> åº”è¯¥å’Œ <code class="docutils literal notranslate"><span class="pre">response</span></code> ä¸€æ ·é•¿ï¼Œå…¶ä¸­éœ€è¦ç®— loss çš„ token ä¸º 1ï¼Œmask æ‰çš„ä¸º 0</p></li>
<li><p><strong>æ¨¡å‹ç”Ÿæˆ</strong>çš„ token (å¦‚æ€è€ƒã€åŠ¨ä½œæŒ‡ä»¤) â†’ <code class="docutils literal notranslate"><span class="pre">loss_mask</span></code> è®¾ä¸º <code class="docutils literal notranslate"><span class="pre">1</span></code>ï¼Œå‚ä¸æŸå¤±è®¡ç®—ã€‚</p></li>
<li><p><strong>å·¥å…·æˆ–ç¯å¢ƒè¿”å›</strong>çš„ token (å¦‚ API ç»“æœ) â†’ <code class="docutils literal notranslate"><span class="pre">loss_mask</span></code> è®¾ä¸º <code class="docutils literal notranslate"><span class="pre">0</span></code>ï¼Œä¸å‚ä¸æŸå¤±è®¡ç®—ã€‚</p></li>
</ul>
</li>
<li><p><strong>ç»ˆæ­¢æ¡ä»¶</strong>: å½“æ¨¡å‹ç”Ÿæˆç»ˆæ­¢æ ‡ç­¾ï¼ˆå¦‚ <code class="docutils literal notranslate"><span class="pre">&lt;answer&gt;...</span></code>ï¼‰æˆ–è¾¾åˆ°æœ€å¤§è½®æ¬¡æ—¶ï¼Œç»“æŸå¾ªç¯ã€‚</p></li>
<li><p><strong>å°è£…è¿”å›</strong>: å°†å®Œæ•´çš„äº¤äº’å†å²ã€token ID å’Œ <code class="docutils literal notranslate"><span class="pre">loss_masks</span></code> å¡«å……åˆ° <code class="docutils literal notranslate"><span class="pre">Sample</span></code> å¯¹è±¡ä¸­å¹¶è¿”å›ã€‚</p></li>
</ol>
<p><strong>ä»£ç ç¤ºä¾‹ï¼ˆæ¦‚å¿µï¼‰</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">sampling_params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sample</span><span class="p">:</span>
    <span class="c1"># ... åˆå§‹åŒ– ...</span>
    <span class="n">prompt</span><span class="p">,</span> <span class="n">full_response</span><span class="p">,</span> <span class="n">loss_masks</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_turns</span><span class="p">):</span>
        <span class="c1"># 1. æ¨¡å‹ç”ŸæˆåŠ¨ä½œ</span>
        <span class="n">model_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_sglang</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">full_response</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="c1"># ... tokenization and appending ...</span>
        <span class="n">loss_masks</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_tokens</span><span class="p">)</span> <span class="c1"># loss_mask = 1</span>
        <span class="n">full_response</span> <span class="o">+=</span> <span class="n">model_output</span>

        <span class="c1"># 2. è§£æå¹¶æ‰§è¡ŒåŠ¨ä½œ</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">parse_action</span><span class="p">(</span><span class="n">model_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;search&quot;</span><span class="p">:</span>
            <span class="c1"># 3 &amp; 4. è·å–å¹¶è¿½åŠ è§‚å¯Ÿç»“æœ</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">google_search</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># ... tokenization and appending ...</span>
            <span class="n">loss_masks</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_tokens</span><span class="p">)</span> <span class="c1"># loss_mask = 0</span>
            <span class="n">full_response</span> <span class="o">+=</span> <span class="n">tool_output</span>
            
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;answer&quot;</span><span class="p">:</span>
            <span class="k">break</span> <span class="c1"># ç»“æŸå¾ªç¯</span>

    <span class="c1"># 7. å¡«å……å¹¶è¿”å› Sample å¯¹è±¡</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">full_response</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">loss_masks</span> <span class="o">=</span> <span class="n">loss_masks</span>
    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3>ç¼–å†™è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<p>ç±»ä¼¼åœ°ï¼Œé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--custom-rm-path</span></code> æŒ‡å®šè‡ªå®šä¹‰å¥–åŠ±å‡½æ•°ã€‚</p>
<p><strong>å‡½æ•°ç­¾å</strong>: <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span> <span class="pre">reward_func(args,</span> <span class="pre">sample:</span> <span class="pre">Sample,</span> <span class="pre">**kwargs)</span> <span class="pre">-&gt;</span> <span class="pre">float:</span></code></p>
<p>è¯¥å‡½æ•°æ¥æ”¶å®Œæ•´çš„ <code class="docutils literal notranslate"><span class="pre">Sample</span></code> å¯¹è±¡ï¼Œæ ¹æ®æœ€ç»ˆäº¤äº’ç»“æœè®¡ç®—å¾—åˆ†ã€‚å¯ä»¥åœ¨æ­¤å®ç°è‡ªå®šä¹‰è®¡åˆ†é€»è¾‘ï¼Œæˆ–è°ƒç”¨å¤–éƒ¨çš„ Reward Model æœåŠ¡ã€‚</p>
</section>
<section id="id12">
<h3>åœ¨è®­ç»ƒè„šæœ¬ä¸­é…ç½®<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p>æœ€åï¼Œåœ¨è®­ç»ƒè„šæœ¬ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹å‚æ•°å¯ç”¨ä¸Šè¿°è‡ªå®šä¹‰å‡½æ•°ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CUSTOM_ARGS</span><span class="o">=(</span>
<span class="w">   </span><span class="c1"># æŒ‡å®šè‡ªå®šä¹‰ç”Ÿæˆå‡½æ•°çš„è·¯å¾„ (æ ¼å¼: path.to.your.file:function_name)</span>
<span class="w">   </span>--custom-generate-function-path<span class="w"> </span>your_module.multiturn_logic:generate

<span class="w">   </span><span class="c1"># æŒ‡å®šè‡ªå®šä¹‰å¥–åŠ±å‡½æ•°çš„è·¯å¾„</span>
<span class="w">   </span>--custom-rm-path<span class="w"> </span>your_module.multiturn_logic:reward_func
<span class="o">)</span>
</pre></div>
</div>
</section>
</section>
<section id="moe">
<h2>å¤§è§„æ¨¡ MOE æ¨¡å‹çš„å¤šæœºè®­ç»ƒ<a class="headerlink" href="#moe" title="Link to this heading">#</a></h2>
<p>ä¸ºäº†å¯åŠ¨å¤šæœºä»»åŠ¡ï¼Œé¦–å…ˆéœ€è¦å¯åŠ¨ä¸€ä¸ª ray é›†ç¾¤ï¼Œå³åœ¨ node 0 è¿è¡Œï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Node0ï¼ˆHEADï¼‰</span>
ray<span class="w"> </span>start<span class="w"> </span>--head<span class="w"> </span>--node-ip-address<span class="w"> </span><span class="si">${</span><span class="nv">MASTER_ADDR</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--num-gpus<span class="w"> </span><span class="m">8</span><span class="w"> </span>--disable-usage-stats

<span class="c1"># å…¶ä»– Node</span>
ray<span class="w"> </span>start<span class="w"> </span>--address<span class="o">=</span><span class="si">${</span><span class="nv">MASTER_ADDR</span><span class="si">}</span>:6379<span class="w"> </span>--num-gpus<span class="w"> </span><span class="m">8</span>
</pre></div>
</div>
<p>åœ¨ ray é›†ç¾¤å¯åŠ¨åï¼Œå¯ä»¥åœ¨ node 0 æäº¤ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray<span class="w"> </span>job<span class="w"> </span>submit<span class="w"> </span>--address<span class="o">=</span><span class="s2">&quot;http://127.0.0.1:8265&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--runtime-env-json<span class="o">=</span><span class="s1">&#39;{</span>
<span class="s1">     &quot;env_vars&quot;: {</span>
<span class="s1">        &quot;PYTHONPATH&quot;: &quot;/root/Megatron-LM/&quot;,</span>
<span class="s1">        ... # e.g. no_proxyã€æ¥å£å˜é‡ç­‰</span>
<span class="s1">     }</span>
<span class="s1">   }&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--<span class="w"> </span>python3<span class="w"> </span>train.py<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--...ï¼ˆå…¶ä»–<span class="w"> </span>Megatron/SGLang/slime<span class="w"> </span>å‚æ•°ï¼‰
</pre></div>
</div>
<p>slime é’ˆå¯¹å¤§è§„æ¨¡æ··åˆä¸“å®¶ï¼ˆMoEï¼‰æ¨¡å‹çš„åˆ†å¸ƒå¼è®­ç»ƒè¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ã€‚æˆ‘ä»¬æä¾›äº†ä¸€äº›ç«¯åˆ°ç«¯çš„è®­ç»ƒæ¡ˆä¾‹ä»¥ä¾›å‚è€ƒï¼š</p>
<ul class="simple">
<li><p><a class="reference internal" href="#models/glm4.5-355B-A32B.md"><span class="xref myst">ç¤ºä¾‹ï¼š64xH100 è®­ç»ƒ GLM-4.5</span></a></p></li>
<li><p><a class="reference internal" href="#models/deepseek-r1.md"><span class="xref myst">ç¤ºä¾‹ï¼š128xH100 è®­ç»ƒ DeepSeek-R1</span></a></p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">ä¸Šä¸€é¡µ</p>
        <p class="prev-next-title">slimeæ–‡æ¡£</p>
      </div>
    </a>
    <a class="right-next"
       href="usage.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">ä¸‹ä¸€é¡µ</p>
        <p class="prev-next-title">ä½¿ç”¨æ–‡æ¡£</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> ç›®å½•
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">åŸºç¡€ç¯å¢ƒæ­å»º</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#docker">æ‹‰å–å¹¶å¯åŠ¨ Docker å®¹å™¨</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#slime">å®‰è£… slime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">æ¨¡å‹ä¸æ•°æ®é›†ä¸‹è½½</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">æ¨¡å‹æƒé‡è½¬æ¢</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hugging-face-megatron">Hugging Face æ ¼å¼ è½¬æ¢ä¸º Megatron æ ¼å¼</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#megatron-hugging-face">Megatron æ ¼å¼ è½¬æ¢ä¸º Hugging Face æ ¼å¼</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">è®­ç»ƒè„šæœ¬ä¸å‚æ•°æ¦‚è§ˆ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-args">MODEL_ARGS: æ¨¡å‹é…ç½®å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ckpt-args">CKPT_ARGS: æ£€æŸ¥ç‚¹ä¸è·¯å¾„å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rollout-args-rollout">ROLLOUT_ARGS: æ•°æ®ç”Ÿæˆï¼ˆRolloutï¼‰å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eval-args">EVAL_ARGS: è¯„ä¼°å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perf-args">PERF_ARGS: æ€§èƒ½ä¸å¹¶è¡Œå‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grpo-args-grpo">GRPO_ARGS: GRPO ç®—æ³•å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizer-args">OPTIMIZER_ARGS: ä¼˜åŒ–å™¨å‚æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sglang-args-sglang">SGLANG_ARGS: SGLang æœåŠ¡å‚æ•°</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">ç‰¹æ€§ä»‹ç»</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#colocated-actor-and-rollout">Colocated Actor and Rollout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-sampling">Dynamic Sampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-rollout">Partial Rollout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bf16-fp8">bf16 è®­ç»ƒ fp8 æ¨ç†</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiturn">Multiturn é€‚é…</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">é€‚é…æ€è·¯æ€»ç»“</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">æ•°æ®å‡†å¤‡ä¸æ˜ å°„</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">æ­¥éª¤ä¸€ï¼šåœ¨æ•°æ®é›†ä¸­æ„é€  <code class="docutils literal notranslate"><span class="pre">metadata</span></code> å­—æ®µ</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">æ­¥éª¤äºŒï¼šåœ¨è®­ç»ƒè„šæœ¬ä¸­æŒ‡å®šæ˜ å°„</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">ç¼–å†™è‡ªå®šä¹‰ç”Ÿæˆå‡½æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">ç¼–å†™è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">åœ¨è®­ç»ƒè„šæœ¬ä¸­é…ç½®</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#moe">å¤§è§„æ¨¡ MOE æ¨¡å‹çš„å¤šæœºè®­ç»ƒ</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
ä½œè€…ï¼š slime Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2025-2025, slime.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  æœ€åæ›´æ–°äº 2025 å¹´ 09 æœˆ 06 æ—¥.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>